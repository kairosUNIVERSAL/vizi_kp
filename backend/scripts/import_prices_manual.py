"""
Direct database import script from manually extracted Excel data.
Run: docker compose exec backend python scripts/import_prices_manual.py

4 main categories:
1. Полотна - все виды полотен
2. Услуги - монтаж, работы, сложности
3. Освещение - светильники, лампы, LED
4. Профили - профили, карнизы, гарпуны
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from sqlalchemy.orm import Session
from app.database import SessionLocal
from app.models import PriceItem, Category

DEFAULT_COMPANY_ID = 1

# 4 основные категории по структуре скриншотов
CATEGORIES_DATA = [
    {"name": "Полотна", "slug": "polotna"},
    {"name": "Услуги", "slug": "uslugi"},
    {"name": "Освещение", "slug": "osveshenie"},
    {"name": "Профили", "slug": "profili"},
]

# Items from screenshots (category_slug, name, price, unit, synonyms)
ITEMS_DATA = [
    # === ПОЛОТНА (screenshot 1) ===
    ("polotna", "MSD Classic Мат 3.2м", 450, "м²", "эконом, msd classic"),
    ("polotna", "MSD Classic Сатин 3.2м", 450, "м²", ""),
    ("polotna", "MSD Classic Глянец 3.2м", 500, "м²", ""),
    ("polotna", "MSD Premium Мат 3.2м", 550, "м²", "экологичный"),
    ("polotna", "MSD Premium Сатин 3.2м", 550, "м²", ""),
    ("polotna", "MSD Premium Глянец 3.2м", 600, "м²", ""),
    ("polotna", "MSD Premium Мат 5м", 650, "м²", "широкий бесшовный"),
    ("polotna", "MSD Premium Сатин 5м", 650, "м²", ""),
    ("polotna", "MSD Premium Глянец 5м", 700, "м²", ""),
    ("polotna", "MSD Premium 5.8м", 750, "м²", "максимальная ширина"),
    ("polotna", "Bauf Мат 3.2м", 550, "м²", "плотное полотно, bauf, полотно бауф"),
    ("polotna", "Bauf Сатин 3.2м", 550, "м²", "bauf, полотно бауф"),
    ("polotna", "Bauf Глянец 3.2м", 590, "м²", "bauf, полотно бауф"),
    ("polotna", "Bauf 4.5м", 650, "м²", "широкий, bauf"),
    ("polotna", "Bauf 5.5м", 700, "м²", "bauf"),
    ("polotna", "Bauf FireProof КМ3 3.2м", 600, "м²", "пожаробезопасный"),
    ("polotna", "Bauf FireProof КМ3 4.5м", 650, "м²", ""),
    ("polotna", "Pongs Мат 3.25м", 700, "м²", "германия премиум, pongs"),
    ("polotna", "Pongs Сатин 3.25м", 700, "м²", "pongs"),
    ("polotna", "Pongs Глянец 3.25м", 750, "м²", "pongs"),
    ("polotna", "DEKEN Мат 3.2м", 600, "м²", "качество, deken"),
    ("polotna", "DEKEN Сатин 3.2м", 600, "м²", "deken"),
    ("polotna", "DEKEN Глянец 3.2м", 650, "м²", "deken"),
    ("polotna", "Descor Ткань 5.1м", 1200, "м²", "германия, без нагрева, descor, тканевый"),
    ("polotna", "Clipso Ткань 5.1м", 1500, "м²", "франция премиум, clipso, тканевый"),
    ("polotna", "MSD/Bauf Мат Цветной 3.2м", 600, "м²", "палитра 150+ цветов"),
    ("polotna", "MSD/Bauf Глянец Цветной 3.2м", 650, "м²", ""),
    ("polotna", "MSD/Bauf Сатин Цветной 3.2м", 600, "м²", ""),
    ("polotna", "MSD/Bauf Мат Чёрный 3.2м", 700, "м²", ""),
    ("polotna", "MSD/Bauf Глянец Чёрный 3.2м", 750, "м²", "зеркальный эффект"),
    
    # === УСЛУГИ (screenshot 2) ===
    ("uslugi", "Монтаж полотна до 3.2м", 350, "м²", "натяжка, установка, монтаж"),
    ("uslugi", "Монтаж полотна 5м широкий", 400, "м²", "пятиметровый"),
    ("uslugi", "Монтаж тканевого полотна", 500, "м²", "ткань, descor, clipso"),
    ("uslugi", "ПВХ профиль стартовый", 200, "м", "багет, стеновой"),
    ("uslugi", "Маскировочная лента белая", 150, "м", "вставка, заглушка"),
    ("uslugi", "Маскировочная лента цветная", 180, "м", ""),
    ("uslugi", "Работа с углами на ПВХ профиле", 200, "м", "угол, внутренний, внешний"),
    ("uslugi", "Соединение полотен (разделитель)", 1490, "м", "стык, разделительный"),
    ("uslugi", "Профиль теневой EuroKraab", 1500, "м", "еврокрааб, евро краб, краб, теневой"),
    ("uslugi", "Профиль теневой EuroKraab Strong", 1700, "м", "усиленный"),
    ("uslugi", "Угол теневого профиля внутренний", 575, "шт", "внутренний угол"),
    ("uslugi", "Угол теневого профиля внешний", 575, "шт", "внешний угол, наружный"),
    ("uslugi", "Теневой профиль Бизон", 900, "м", "bizon"),
    ("uslugi", "Бесщелевой профиль KRAAB 3.0", 900, "м", "без щели"),
    ("uslugi", "Парящий профиль с подсветкой", 1600, "м", "парящий, подсветка периметра"),
    ("uslugi", "Парящий профиль без подсветки", 1200, "м", ""),
    ("uslugi", "Угол парящего профиля", 800, "шт", ""),
    ("uslugi", "Трековое освещение (профиль+монтаж)", 6000, "м", "трек, трековый, шинопровод"),
    ("uslugi", "Обработка торцов на треке", 3000, "шт", "торец, заглушка"),
    ("uslugi", "Работа с углами на треке", 1000, "шт", "угол трека"),
    ("uslugi", "Подключение трекового оборудования", 1500, "шт", "запуск, подключение"),
    ("uslugi", "Закладная под накладной трек", 990, "м", "накладной шинопровод"),
    ("uslugi", "Установка накладного трека", 550, "м", ""),
    ("uslugi", "Световая линия (профиль+монтаж)", 2300, "м", "светолиния, свет линия"),
    ("uslugi", "Монтаж светодиодной ленты", 300, "м", "LED лента"),
    ("uslugi", "Установка рассеивателя", 900, "м", "диффузор"),
    ("uslugi", "Работа с углами световой линии", 2500, "шт", "угол световой"),
    ("uslugi", "Пайка ленты на углах", 500, "шт", "спайка"),
    ("uslugi", "Подключение блоков питания", 1500, "шт", "блок, драйвер"),
    ("uslugi", "Торец/заглушка световой линии", 350, "шт", "закладная под светильник"),
    ("uslugi", "Закладная под точечный светильник", 350, "шт", "точечник, спот"),
    ("uslugi", "Установка светильника накладного", 600, "шт", "накладной"),
    ("uslugi", "Установка светильника (вклейка кольца)", 920, "шт", "вклейска кольца"),
    ("uslugi", "Установка прямоугольного светильника", 1800, "шт", "прямоугольный, квадратный"),
    ("uslugi", "Закладная под люстру", 400, "шт", "платформа под люстру"),
    ("uslugi", "Закладная под люстру усиленная", 500, "шт", "тяжелая люстра"),
    ("uslugi", "Установка люстры (без сборки)", 500, "шт", "подключение люстры"),
    ("uslugi", "Установка люстры (со сборкой)", 1000, "шт", "сборка люстры"),
    ("uslugi", "Установка люстры тяжелой (15-30 кг)", 1500, "шт", ""),
    ("uslugi", "Прокладка проводки для светильников", 150, "м", "кабель, провод"),
    ("uslugi", "Ниша под шторы (профиль ПК-5)", 3600, "м", "скрытый карниз, ниша"),
    ("uslugi", "Ниша под шторы SLOTT", 8000, "м", "слот, премиум"),
    ("uslugi", "Закладная под гардину", 800, "м", "под карниз"),
    ("uslugi", "Установка карниза", 1000, "м", ""),
    ("uslugi", "Установка электрокарниза", 4500, "шт", "моторизованный"),
    ("uslugi", "Закладная под вытяжку/вентилятор", 500, "шт", "вентиляция"),
    ("uslugi", "Установка вытяжки/вентилятора", 1200, "шт", ""),
    ("uslugi", "Установка вентиляционной решётки", 500, "шт", "решётка"),
    ("uslugi", "Демонтаж/монтаж пожарного датчика", 1000, "шт", "пожарный датчик"),
    ("uslugi", "Обход трубы (до 32мм)", 300, "шт", "труба, обход трубы"),
    ("uslugi", "Обход трубы (32-55мм)", 500, "шт", "обход трубы"),
    ("uslugi", "Обход трубы (55-110мм)", 850, "шт", "обход трубы"),
    ("uslugi", "Обход ригеля/балки", 5000, "шт", "ригель, балка"),
    ("uslugi", "Обход колонны", 3000, "шт", "колонна"),
    ("uslugi", "Работа по кафелю", 150, "м", "плитка, сверление"),
    ("uslugi", "Работа по керамограниту", 500, "м", "керамогранит"),
    ("uslugi", "Крепление в металл", 500, "м", "металлоконструкция"),
    ("uslugi", "Работа на высоте (3-4м)", 100, "м²", "высокие потолки"),
    ("uslugi", "Работа на высоте (от 4м)", 200, "м²", "леса"),
    ("uslugi", "Усиление (конструктив)", 300, "м", "усиленная закладная"),
    ("uslugi", "Работа по ГКЛ (гипсокартон)", 200, "м", "гипсокартон"),
    ("uslugi", "Работа по утеплителю", 300, "м", "минвата, пенопласт"),
    ("uslugi", "Демонтаж полотна", 150, "м²", "снятие, демонтаж"),
    ("uslugi", "Демонтаж полотна (с сохранением)", 250, "м²", "аккуратный демонтаж"),
    ("uslugi", "Демонтаж профиля", 500, "м", "демонтаж"),
    ("uslugi", "Демонтаж люстры", 500, "шт", "демонтаж"),
    ("uslugi", "Установка распаячной коробки", 200, "шт", ""),
    ("uslugi", "Обеспыливание помещения", 100, "м²", "уборка, защита"),
    ("uslugi", "Защита мебели плёнкой", 300, "шт", ""),
    ("uslugi", "Вынос мусора", 500, "шт", ""),
    
    # === ОСВЕЩЕНИЕ (screenshot 3) ===
    ("osveshenie", "Светильник GX53 белый круглый", 150, "шт", "базовый, точечный, gx53"),
    ("osveshenie", "Светильник GX53 белый квадратный", 180, "шт", "gx53"),
    ("osveshenie", "Светильник GX53 чёрный круглый", 200, "шт", "gx53"),
    ("osveshenie", "Светильник GX53 хром круглый", 200, "шт", "gx53"),
    ("osveshenie", "Светильник GX53 золото круглый", 200, "шт", "gx53"),
    ("osveshenie", "Светильник GX53 с LED подсветкой", 350, "шт", "с декоративной подсветкой"),
    ("osveshenie", "Светильник GX53 влагозащищённый IP44", 250, "шт", "для ванной"),
    ("osveshenie", "Светильник GX53 накладной (спот)", 300, "шт", "накладной"),
    ("osveshenie", "Лампа GX53 LED 6W тёплый", 150, "шт", "3000K, лампа"),
    ("osveshenie", "Лампа GX53 LED 6W нейтральный", 150, "шт", "4000K, лампа"),
    ("osveshenie", "Лампа GX53 LED 6W холодный", 150, "шт", "6000K, лампа"),
    ("osveshenie", "Лампа GX53 LED 9W тёплый", 200, "шт", "лампа"),
    ("osveshenie", "Лампа GX53 LED 9W нейтральный", 200, "шт", "лампа"),
    ("osveshenie", "Лампа GX53 LED 12W тёплый", 250, "шт", "максимальная яркость, лампа"),
    ("osveshenie", "Лампа GX53 LED 12W нейтральный", 250, "шт", "лампа"),
    ("osveshenie", "Светильник MR16 белый", 120, "шт", "GU5.3, mr16"),
    ("osveshenie", "Светильник MR16 чёрный", 150, "шт", "mr16"),
    ("osveshenie", "Светильник MR16 хром", 180, "шт", "mr16"),
    ("osveshenie", "Лампа MR16 LED 5W", 100, "шт", "GU5.3, лампа"),
    ("osveshenie", "Лампа MR16 LED 7W", 150, "шт", "лампа"),
    ("osveshenie", "Светильник трековый 10W белый", 1500, "шт", "для шинопровода, трековый"),
    ("osveshenie", "Светильник трековый 10W чёрный", 1500, "шт", "трековый"),
    ("osveshenie", "Светильник трековый 20W белый", 2000, "шт", "трековый"),
    ("osveshenie", "Светильник трековый 20W чёрный", 2000, "шт", "трековый"),
    ("osveshenie", "Светильник трековый 30W", 2500, "шт", "мощный, трековый"),
    ("osveshenie", "Светильник трековый поворотный", 2500, "шт", "с регулировкой, трековый"),
    ("osveshenie", "Светильник накладной круглый 12W", 800, "шт", "LED панель, накладной"),
    ("osveshenie", "Светильник накладной круглый 18W", 1000, "шт", "накладной"),
    ("osveshenie", "Светильник накладной квадратный 12W", 1000, "шт", "накладной"),
    ("osveshenie", "Светильник накладной квадратный 18W", 1200, "шт", "накладной"),
    ("osveshenie", "Светильник-стакан GU10", 600, "шт", "декоративный"),
    ("osveshenie", "Светильник-цилиндр", 800, "шт", ""),
    ("osveshenie", "Светильник линейный 60см 18W", 1200, "шт", "для офисов, линейный"),
    ("osveshenie", "Светильник линейный 120см 36W", 1800, "шт", "линейный"),
    ("osveshenie", "Светильник встраиваемый прямоугольный", 1800, "шт", "армстронг"),
    ("osveshenie", "Лента LED 12V 60д/м тёплая", 200, "м", "SMD 2835, за метр, лед лента"),
    ("osveshenie", "Лента LED 12V 60д/м нейтральная", 200, "м", "лед лента"),
    ("osveshenie", "Лента LED 12V 60д/м холодная", 200, "м", "лед лента"),
    ("osveshenie", "Лента LED 12V 120д/м тёплая", 350, "м", "яркая, лед лента"),
    ("osveshenie", "Лента LED 24V 120д/м", 400, "м", "профессиональная, лед лента"),
    ("osveshenie", "Лента LED RGB", 500, "м", "многоцветная, лед лента"),
    ("osveshenie", "Лента LED RGBW", 700, "м", "RGB + белый, лед лента"),
    ("osveshenie", "Блок питания 12V 36W", 500, "шт", "до 7м ленты"),
    ("osveshenie", "Блок питания 12V 60W", 700, "шт", "до 12м ленты"),
    ("osveshenie", "Блок питания 12V 100W", 1000, "шт", "до 20м ленты"),
    ("osveshenie", "Блок питания 12V 150W", 1300, "шт", ""),
    ("osveshenie", "Блок питания 24V 100W", 1200, "шт", ""),
    ("osveshenie", "Блок питания 24V 200W", 1800, "шт", ""),
    ("osveshenie", "Профиль алюминиевый накладной", 200, "м", "за метр, LED профиль"),
    ("osveshenie", "Профиль алюминиевый врезной", 300, "м", "LED профиль"),
    ("osveshenie", "Профиль алюминиевый угловой", 350, "м", "LED профиль"),
    ("osveshenie", "Рассеиватель матовый", 100, "м", "за метр"),
    ("osveshenie", "Рассеиватель прозрачный", 80, "м", ""),
    ("osveshenie", "Заглушка для профиля", 50, "шт", "пара"),
    ("osveshenie", "Люстра LED современная 60W", 8000, "шт", "с пультом, люстра"),
    ("osveshenie", "Люстра LED кольца 80W", 12000, "шт", "дизайнерская, люстра"),
    ("osveshenie", "Люстра классическая 5 рожков", 5000, "шт", "люстра"),
    ("osveshenie", "Люстра хрустальная", 15000, "шт", "премиум, люстра"),
    ("osveshenie", "Закладная универсальная 50-90мм", 80, "шт", "пластиковая"),
    ("osveshenie", "Закладная универсальная 90-115мм", 100, "шт", ""),
    ("osveshenie", "Закладная под люстру", 150, "шт", ""),
    ("osveshenie", "Термокольцо 60мм", 30, "шт", ""),
    ("osveshenie", "Термокольцо 80мм", 35, "шт", ""),
    ("osveshenie", "Термокольцо 90мм", 40, "шт", ""),
    ("osveshenie", "Термокольцо 112мм", 50, "шт", ""),
    ("osveshenie", "Подвес для закладной", 30, "шт", ""),
    ("osveshenie", "Перфолента 12мм", 50, "м", "за метр"),
    
    # === ПРОФИЛИ (screenshot 4) ===
    ("profili", "Профиль ПВХ стеновой стартовый", 90, "м", "базовый монтаж, пвх профиль"),
    ("profili", "Профиль ПВХ потолочный", 100, "м", "при низких потолках, пвх профиль"),
    ("profili", "Маскировочная лента белая TL", 50, "м", "заглушка"),
    ("profili", "Маскировочная лента цветная", 80, "м", ""),
    ("profili", "EUROKRAAB стеновой", 350, "м", "теневой зазор 6мм, теневой"),
    ("profili", "EUROKRAAB Strong", 450, "м", "усиленный, теневой"),
    ("profili", "EUROKRAAB потолочный", 400, "м", "теневой"),
    ("profili", "Угол EUROKRAAB внутренний", 200, "шт", "90°"),
    ("profili", "Угол EUROKRAAB внешний", 350, "шт", "90°"),
    ("profili", "Профиль Бизон теневой", 250, "м", "бюджетный теневой"),
    ("profili", "KRAAB 3.0", 300, "м", "без щели, бесщелевой"),
    ("profili", "KRAAB GIPPS", 500, "м", "под гипсокартон, бесщелевой"),
    ("profili", "Парящий профиль с подсветкой", 600, "м", "LED внутри, парящий"),
    ("profili", "Парящий профиль без подсветки", 400, "м", "парящий"),
    ("profili", "Профиль световой линии 30мм", 800, "м", "узкая, световая линия"),
    ("profili", "Профиль световой линии 50мм", 1000, "м", "стандарт, световая линия"),
    ("profili", "Профиль световой линии 80мм", 1200, "м", "широкая, световая линия"),
    ("profili", "Трековый профиль встраиваемый", 2000, "м", "для шинопровода, трек"),
    ("profili", "Магнитный трек встраиваемый", 3000, "м", "премиум, трек"),
    ("profili", "ПК-5 карниз двухрядный", 700, "м", "эконом, карниз"),
    ("profili", "ПК-15 карниз двухрядный", 1200, "м", "стандарт, карниз"),
    ("profili", "SLOTT карниз", 1500, "м", "премиум, карниз"),
    ("profili", "Flexy GARDINA двухрядный", 1800, "м", "с бегунками, карниз"),
    ("profili", "Разделительный профиль", 500, "м", "стык полотен"),
    ("profili", "Профиль перехода уровней", 800, "м", "многоуровневый"),
    ("profili", "Гарпун для ПВХ полотна", 25, "м", "расходник, гарпун"),
    ("profili", "Гарпун KRAAB", 35, "м", "для теневого, гарпун"),
]


def get_or_create_category(db: Session, slug: str, name: str, sort_order: int) -> Category:
    category = db.query(Category).filter(Category.slug == slug).first()
    if not category:
        category = Category(name=name, slug=slug, sort_order=sort_order, is_system=False)
        db.add(category)
        db.commit()
        db.refresh(category)
        print(f"  Created category: {name}")
    return category


def import_all(company_id: int = DEFAULT_COMPANY_ID):
    db = SessionLocal()
    
    try:
        # Create categories
        print("\n=== Creating Categories ===")
        category_map = {}
        for i, cat_data in enumerate(CATEGORIES_DATA):
            cat = get_or_create_category(db, cat_data["slug"], cat_data["name"], i + 1)
            category_map[cat_data["slug"]] = cat.id
        
        # Create items
        print("\n=== Importing Items ===")
        imported = 0
        skipped = 0
        
        for cat_slug, name, price, unit, synonyms in ITEMS_DATA:
            # Skip if category not found
            if cat_slug not in category_map:
                print(f"  Warning: Category '{cat_slug}' not found for item '{name}'")
                continue
            
            # Check existing
            existing = db.query(PriceItem).filter(
                PriceItem.company_id == company_id,
                PriceItem.name == name
            ).first()
            
            if existing:
                # Update existing item to ensure it's correct and active
                existing.price = price
                existing.unit = unit
                existing.synonyms = synonyms
                existing.is_active = True
                existing.category_id = category_map[cat_slug]
                db.add(existing)
                db.commit()
                print(f"  Updated: {name}")
                skipped += 1
                continue
            
            item = PriceItem(
                company_id=company_id,
                category_id=category_map[cat_slug],
                name=name,
                price=price,
                unit=unit,
                synonyms=synonyms,
                is_active=True,
                is_custom=True
            )
            db.add(item)
            db.commit()
            print(f"  Imported: {name} ({price} ₽/{unit})")
            imported += 1
        
        print(f"\n=== Import Complete ===")
        print(f"Categories: {len(category_map)}")
        print(f"Items imported: {imported}")
        print(f"Items skipped: {skipped}")
        
    finally:
        db.close()


if __name__ == '__main__':
    company_id = DEFAULT_COMPANY_ID
    if len(sys.argv) > 1:
        try:
            company_id = int(sys.argv[1])
        except ValueError:
            pass
    
    print(f"Importing prices for company_id={company_id}")
    import_all(company_id)
